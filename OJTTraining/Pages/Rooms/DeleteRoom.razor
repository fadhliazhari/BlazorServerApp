@page "/DeleteRoom/{Id}"
@attribute [Authorize(Roles = "infra")]

@using System.Globalization
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthenticationStateProvider

@using OJTTraining.Data
@using OJTTraining.Service
@inject RoomService roomService
@inject NavigationManager NavigationManager

<h2>Delete Room</h2>
<hr />

<div>
    @if (editContext is not null)
    {
        <EditForm EditContext="@editContext">
            <ValidationSummary></ValidationSummary>
        </EditForm>
    }

    <div class="form-group">
        <label for="RoomNumber" class="font-weight-bold">Room Number:</label>
        <label id="RoomNumber">@obj.RoomNumber</label>
    </div>
    <div class="form-group">
        <label for="RoomCapacity" class="font-weight-bold">Room Capacity:</label>
        <label id="RoomCapacity">@obj.RoomCapacity</label>
    </div>
    <div class="form-group">
        <label for="RoomCapacity" class="font-weight-bold">No of Patients:</label>
        <label id="RoomCapacity">
            <a class="nav-link" href="@queryString">
                <b>@noOfPatients</b>
            </a>
        </label>
    </div>

    <button class="btn btn-danger" @onclick="Delete">Delete</button>
    <button class="btn btn-secondary" @onclick="Cancel">Cancel</button>
</div>

@code {
    [CascadingParameter] public IModalService Modal { get; set; }

    [Parameter] public string Id { get; set; }

    private Room obj = new Room();

    private int noOfPatients;
    private string queryString;

    private EditContext editContext;
    private ValidationMessageStore messageStore;

    protected override async Task OnInitializedAsync()
    {
        obj = await Task.Run(() => roomService.GetRoomAsync(Id));

        editContext = new(obj);
        messageStore = new(editContext);

        noOfPatients = await roomService.GetNoUsedAsync(obj);
        queryString = $"Patients?roomNumber={obj.RoomNumber}&checkinBy={DateTime.Now.ToString("d", CultureInfo.CurrentCulture)}&checkoutBefore={DateTime.Now.ToString("d", CultureInfo.CurrentCulture)}";
    }

    protected async Task Delete()
    {
        messageStore.Clear();

        var isUsed = await roomService.CheckIfUsedAsync(obj);

        if (isUsed)
        {
            messageStore.Add(() => obj.RoomNumber, "Room is currently being used");
        }

        editContext.NotifyValidationStateChanged();

        if (!isUsed)
        {
            var options = new ModalOptions()
            {
                Animation = ModalAnimation.FadeInOut(0.1)
            };

            var deleteDialog = Modal.Show<DeleteConfirmation>("Delete", options);
            var result = await deleteDialog.Result;

            if (!result.Cancelled)
            {
                await DeleteCallback();
            }
        }
    }

    protected async Task DeleteCallback()
    {
        await roomService.DeleteRoomAsync(obj);
        NavigationManager.NavigateTo("Rooms");
    }

    protected void Cancel()
    {
        NavigationManager.NavigateTo("Rooms");
    }
}
